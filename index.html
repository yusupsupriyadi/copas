<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self'; base-uri 'none'">
    <title>Copas</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="controls">
                <input type="text" id="searchInput" class="search-input no-drag" placeholder="Search snippets...">
                <button class="btn no-drag" id="addBtn">+ ADD</button>
                <button class="btn btn-icon no-drag" id="settingsBtn" title="Settings">‚öôÔ∏è</button>
            </div>
            <div class="stats">
                <span id="totalSnippets">0 snippets</span>
                <span id="filteredSnippets"></span>
            </div>
        </div>


        <div id="snippetsContainer">
            <div class="empty-state">
                <h3>No snippets yet</h3>
                <p>Click "ADD" button to create your first snippet</p>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item edit" id="contextEdit">‚úèÔ∏è Edit</div>
        <div class="context-menu-item delete" id="contextDelete">üóëÔ∏è Delete</div>
    </div>

    <!-- Modal Add/Edit Snippet -->
    <div id="snippetModal" class="modal">
        <div class="modal-content">
            <div class="modal-body">
                <form id="snippetForm">
                    <div class="form-group">
                        <textarea id="snippetContent" required placeholder="Paste your code or text snippet here..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary no-drag" id="cancelSnippetBtn">CANCEL</button>
                <button class="btn no-drag" id="saveSnippetBtn">SAVE</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
            </div>
            <div class="modal-body">
                <div class="setting-item">
                    <label>Dark Mode</label>
                    <div class="toggle-container">
                        <input type="checkbox" id="darkModeToggle" class="toggle-input">
                        <label for="darkModeToggle" class="toggle-label">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="setting-item">
                    <label>Auto Start on Boot</label>
                    <div class="toggle-container">
                        <input type="checkbox" id="autoStartToggle" class="toggle-input">
                        <label for="autoStartToggle" class="toggle-label">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary no-drag" id="closeSettingsBtn">CLOSE</button>
            </div>
        </div>
    </div>

    <script type="application/json" data-legacy="true">
        let snippets = [];
        let currentEditId = null;
        let filteredSnippets = [];

        // Load snippets from localStorage on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSnippets();
            renderSnippets();
            updateStats();

            // Search functionality
            document.getElementById('searchInput').addEventListener('input', function(e) {
                filterSnippets(e.target.value);
            });

            // Close modal when clicking outside
            document.getElementById('snippetModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });

            // Handle Escape key to close modal
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && document.getElementById('snippetModal').style.display === 'block') {
                    closeModal();
                }
            });
        });

        function loadSnippets() {
            const saved = localStorage.getItem('snippets');
            if (saved) {
                snippets = JSON.parse(saved);
            }
            filteredSnippets = [...snippets];
        }

        function saveToStorage() {
            localStorage.setItem('snippets', JSON.stringify(snippets));
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function openAddModal() {
            console.log('Opening add modal...'); // Debug log
            currentEditId = null;
            document.getElementById('snippetContent').value = '';
            const modal = document.getElementById('snippetModal');
            modal.style.display = 'block';
            modal.classList.add('show');
            setTimeout(() => {
                document.getElementById('snippetContent').focus();
            }, 100);
        }

        function openEditModal(id) {
            const snippet = snippets.find(s => s.id === id);
            if (!snippet) return;

            currentEditId = id;
            document.getElementById('snippetContent').value = snippet.content;
            const modal = document.getElementById('snippetModal');
            modal.style.display = 'block';
            modal.classList.add('show');
            setTimeout(() => {
                document.getElementById('snippetContent').focus();
            }, 100);
        }

        function closeModal() {
            console.log('Closing modal...'); // Debug log
            const modal = document.getElementById('snippetModal');
            modal.style.display = 'none';
            modal.classList.remove('show');
            currentEditId = null;
        }

        function generateTitle(content) {
            // Ambil 50 karakter pertama dari konten sebagai title
            const firstLine = content.split('\n')[0].trim();
            if (firstLine.length > 0) {
                return firstLine.length > 50 ? firstLine.substring(0, 50) + '...' : firstLine;
            }
            return content.length > 50 ? content.substring(0, 50) + '...' : content;
        }

        function saveSnippet() {
            const content = document.getElementById('snippetContent').value.trim();

            if (!content) {
                alert('Content is required!');
                return;
            }

            const title = generateTitle(content);

            if (currentEditId) {
                // Edit existing snippet
                const index = snippets.findIndex(s => s.id === currentEditId);
                if (index !== -1) {
                    snippets[index] = {
                        ...snippets[index],
                        title,
                        content,
                        updatedAt: new Date().toISOString()
                    };
                }
            } else {
                // Add new snippet
                const newSnippet = {
                    id: generateId(),
                    title,
                    content,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                snippets.unshift(newSnippet);
            }

            saveToStorage();
            closeModal();
            filterSnippets(document.getElementById('searchInput').value);
            updateStats();
        }

        function deleteSnippet(id) {
            if (confirm('Are you sure you want to delete this snippet?')) {
                snippets = snippets.filter(s => s.id !== id);
                saveToStorage();
                filterSnippets(document.getElementById('searchInput').value);
                updateStats();
            }
        }

        async function copySnippet(content, cardElement) {
            try {
                await navigator.clipboard.writeText(content);
                // Visual feedback
                const originalBg = cardElement.style.backgroundColor;
                const originalBorder = cardElement.style.borderColor;
                
                cardElement.style.backgroundColor = '#e8f5e8';
                cardElement.style.borderColor = '#4CAF50';
                cardElement.style.transform = 'scale(0.98)';
                
                setTimeout(() => {
                    cardElement.style.backgroundColor = originalBg;
                    cardElement.style.borderColor = originalBorder;
                    cardElement.style.transform = '';
                }, 200);
            } catch (err) {
                alert('Failed to copy to clipboard');
                console.error('Failed to copy: ', err);
            }
        }

        // Context Menu Variables and Functions
        let contextMenuSnippetId = null;

        function showContextMenu(event, snippetId) {
            event.preventDefault();
            contextMenuSnippetId = snippetId;
            
            const contextMenu = document.getElementById('contextMenu');
            contextMenu.style.display = 'block';
            contextMenu.style.left = event.pageX + 'px';
            contextMenu.style.top = event.pageY + 'px';
        }

        function hideContextMenu() {
            const contextMenu = document.getElementById('contextMenu');
            contextMenu.style.display = 'none';
            contextMenuSnippetId = null;
        }

        function contextEdit() {
            if (contextMenuSnippetId) {
                openEditModal(contextMenuSnippetId);
                hideContextMenu();
            }
        }

        function contextDelete() {
            if (contextMenuSnippetId) {
                deleteSnippet(contextMenuSnippetId);
                hideContextMenu();
            }
        }

        // Hide context menu when clicking elsewhere
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.context-menu') && !e.target.closest('.snippet-card')) {
                hideContextMenu();
            }
        });

        function filterSnippets(searchTerm) {
            if (!searchTerm.trim()) {
                filteredSnippets = [...snippets];
            } else {
                const term = searchTerm.toLowerCase();
                filteredSnippets = snippets.filter(snippet => 
                    snippet.title.toLowerCase().includes(term) || 
                    snippet.content.toLowerCase().includes(term)
                );
            }
            renderSnippets();
            updateStats();
        }

        function renderSnippets() {
            const container = document.getElementById('snippetsContainer');
            
            if (filteredSnippets.length === 0) {
                const searchTerm = document.getElementById('searchInput').value.trim();
                if (searchTerm) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No results found</h3>
                            <p>No snippets found matching "${searchTerm}"</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No snippets yet</h3>
                            <p>Click "ADD" button to create your first snippet</p>
                        </div>
                    `;
                }
                return;
            }

            const html = `
                <div class="snippets-grid">
                    ${filteredSnippets.map(snippet => {
                        const preview = snippet.content.length > 100 
                            ? snippet.content.substring(0, 100) + '...' 
                            : snippet.content;
                        
                        return `
                            <div class="snippet-card" data-id="${snippet.id}" onclick="copySnippet(\`${escapeHtml(snippet.content).replace(/`/g, '\\\\`')}\`, this)" oncontextmenu="showContextMenu(event, '${snippet.id}'); return false;" style="cursor: pointer;" title="Click to copy">
                                <div class="snippet-content">${escapeHtml(preview)}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            container.innerHTML = html;
        }

        function updateStats() {
            const total = snippets.length;
            const filtered = filteredSnippets.length;
            const searchTerm = document.getElementById('searchInput').value.trim();
            
            document.getElementById('totalSnippets').textContent = `${total} snippet${total !== 1 ? 's' : ''}`;
            
            if (searchTerm && filtered !== total) {
                document.getElementById('filteredSnippets').textContent = `(${filtered} shown)`;
            } else {
                document.getElementById('filteredSnippets').textContent = '';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Handle form submission with Enter
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.ctrlKey && document.getElementById('snippetModal').style.display === 'block') {
                saveSnippet();
            }
        });

        // Settings Modal Functions
        function openSettingsModal() {
            const modal = document.getElementById('settingsModal');
            modal.style.display = 'block';
            modal.classList.add('show');
            
            // Load current dark mode setting
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            document.getElementById('darkModeToggle').checked = isDarkMode;
            
            // Load current auto start setting
            const isAutoStart = localStorage.getItem('autoStart') === 'true';
            document.getElementById('autoStartToggle').checked = isAutoStart;
        }

        function closeSettingsModal() {
            const modal = document.getElementById('settingsModal');
            modal.style.display = 'none';
            modal.classList.remove('show');
        }

        // Dark Mode Functions
        function toggleDarkMode() {
            const isEnabled = document.getElementById('darkModeToggle').checked;
            localStorage.setItem('darkMode', isEnabled);
            applyDarkMode(isEnabled);
        }

        function applyDarkMode(isDarkMode) {
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }

        // Auto Start Functions
        function toggleAutoStart() {
            const isEnabled = document.getElementById('autoStartToggle').checked;
            localStorage.setItem('autoStart', isEnabled);
            
            // Send message to main process to enable/disable auto start
            if (window.electronAPI && window.electronAPI.setAutoStart) {
                window.electronAPI.setAutoStart(isEnabled);
            }
        }

        // Load settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            applyDarkMode(isDarkMode);
            
            // Add event listeners
            document.getElementById('darkModeToggle').addEventListener('change', toggleDarkMode);
            document.getElementById('autoStartToggle').addEventListener('change', toggleAutoStart);
        });

        // Close settings modal when clicking outside
        document.getElementById('settingsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSettingsModal();
            }
        });

        // Handle Escape key for settings modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('settingsModal').style.display === 'block') {
                closeSettingsModal();
            }
        });
    </script>
    <script src="renderer.js" defer></script>
</body>
</html>
